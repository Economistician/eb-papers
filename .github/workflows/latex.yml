name: Build EB PDFs (Release Assets)

on:
  push:
    tags: ["v*"]
  workflow_dispatch:

permissions:
  contents: write

concurrency:
  group: eb-papers-release-${{ github.ref }}
  cancel-in-progress: false

jobs:
  build-pdfs:
    name: Build PDFs (${{ matrix.id }})
    runs-on: ubuntu-latest

    strategy:
      fail-fast: false
      matrix:
        include:
          # --- Technical Notes ---
          - id: TN_CWSL
            working_directory: technical-notes/cwsl
            base_name: ElectricBarometer_TN_CWSL

          - id: TN_CWSLR
            working_directory: technical-notes/cwslr
            base_name: ElectricBarometer_TN_CWSLR

          - id: TN_DQC
            working_directory: technical-notes/dqc
            base_name: ElectricBarometer_TN_DQC

          - id: TN_FPC
            working_directory: technical-notes/fpc
            base_name: ElectricBarometer_TN_FPC

          - id: TN_FRS
            working_directory: technical-notes/frs
            base_name: ElectricBarometer_TN_FRS

          - id: TN_GOVERNANCE
            working_directory: technical-notes/governance
            base_name: ElectricBarometer_TN_GOVERNANCE

          - id: TN_HRAT
            working_directory: technical-notes/hrat
            base_name: ElectricBarometer_TN_HRAT

          - id: TN_HRTAU
            working_directory: technical-notes/hrtau
            base_name: ElectricBarometer_TN_HRTAU

          - id: TN_NSL
            working_directory: technical-notes/nsl
            base_name: ElectricBarometer_TN_NSL

          - id: TN_RAL
            working_directory: technical-notes/ral
            base_name: ElectricBarometer_TN_RAL

          - id: TN_UD
            working_directory: technical-notes/ud
            base_name: ElectricBarometer_TN_UD

          # --- Business Briefs ---
          - id: BB_FRF
            working_directory: business-briefs/frf
            base_name: ElectricBarometer_BB_FRF

          - id: BB_CWSL
            working_directory: business-briefs/cwsl
            base_name: ElectricBarometer_BB_CWSL

          # --- Technical Papers ---
          - id: PAPER_FRF
            working_directory: technical-papers/frf
            base_name: ElectricBarometer_PAPER_FRF

          - id: PAPER_LTOR
            working_directory: technical-papers/ltor
            base_name: ElectricBarometer_PAPER_LTOR

    steps:
      - name: Check out repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Compile LaTeX
        uses: xu-cheng/latex-action@v3
        env:
          # Single colon-delimited TEXINPUTS string (avoid YAML folding inserting spaces).
          # Keep trailing ":" so TeX still searches its default paths.
          TEXINPUTS: ".:${{ github.workspace }}:${{ github.workspace }}/macros:${{ github.workspace }}/${{ matrix.working_directory }}:${{ github.workspace }}/${{ matrix.working_directory }}/sections:${{ github.workspace }}/${{ matrix.working_directory }}/figures:${{ github.workspace }}/${{ matrix.working_directory }}/tables:"
        with:
          root_file: main.tex
          working_directory: ${{ matrix.working_directory }}

      - name: Create versioned + latest PDF files
        shell: bash
        run: |
          set -euo pipefail

          TAG="${GITHUB_REF_NAME}"  # e.g., v0.2.1
          src="${{ matrix.working_directory }}/main.pdf"

          mkdir -p out

          versioned="out/${{ matrix.base_name }}_${TAG}.pdf"
          latest="out/${{ matrix.base_name }}_latest.pdf"

          mv "$src" "$versioned"
          cp "$versioned" "$latest"

          echo "Built: $versioned"
          echo "Built: $latest"

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: ${{ matrix.id }}
          path: out/

  attach-to-release:
    name: Attach PDFs to Release
    runs-on: ubuntu-latest
    needs: [build-pdfs]

    steps:
      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: dist

      - name: Collect PDFs
        shell: bash
        run: |
          set -euo pipefail
          shopt -s nullglob

          mkdir -p release
          find dist -type f -name "*.pdf" -print -exec cp {} release/ \;

          ls -la release

      - name: Attach PDFs to GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          files: release/*.pdf
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

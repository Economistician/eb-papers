name: Build EB PDFs (Release Assets)

on:
  push:
    tags: ["v*"]
  workflow_dispatch:

permissions:
  contents: write

concurrency:
  group: eb-papers-release-${{ github.ref }}
  cancel-in-progress: false

jobs:
  build-pdfs:
    name: Build PDFs (${{ matrix.id }})
    runs-on: ubuntu-latest

    strategy:
      fail-fast: false
      matrix:
        include:
          # --- Technical Notes ---
          - id: TN_CWSL
            working_directory: cwsl/technical-notes
            base_name: ElectricBarometer_TN_CWSL

          - id: TN_CWSLR
            working_directory: cwslr/technical-notes
            base_name: ElectricBarometer_TN_CWSLR

          - id: TN_FRS
            working_directory: frs/technical-notes
            base_name: ElectricBarometer_TN_FRS

          - id: TN_HRAT
            working_directory: hrat/technical-notes
            base_name: ElectricBarometer_TN_HRAT

          - id: TN_HRTAU
            working_directory: hrtau/technical-notes
            base_name: ElectricBarometer_TN_HRTAU

          - id: TN_NSL
            working_directory: nsl/technical-notes
            base_name: ElectricBarometer_TN_NSL

          - id: TN_RAL
            working_directory: ral/technical-notes
            base_name: ElectricBarometer_TN_RAL

          - id: TN_UD
            working_directory: ud/technical-notes
            base_name: ElectricBarometer_TN_UD

          # --- Papers ---
          - id: PAPER_FRF
            working_directory: frf/paper
            base_name: ElectricBarometer_PAPER_FRF

          - id: PAPER_LTOR
            working_directory: ltor/paper
            base_name: ElectricBarometer_PAPER_LTOR

    steps:
      - name: Check out repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Compile LaTeX
        uses: xu-cheng/latex-action@v3
        env:
          # Allow \input{...} to resolve files located in <doc-root>/sections/
          TEXINPUTS: ".:${{ github.workspace }}/${{ matrix.working_directory }}/sections/:"
        with:
          root_file: main.tex
          working_directory: ${{ matrix.working_directory }}

      - name: Create versioned + latest PDF files
        shell: bash
        run: |
          set -euo pipefail

          TAG="${GITHUB_REF_NAME}"  # e.g., v0.2.1
          src="${{ matrix.working_directory }}/main.pdf"

          mkdir -p out

          versioned="out/${{ matrix.base_name }}_${TAG}.pdf"
          latest="out/${{ matrix.base_name }}_latest.pdf"

          mv "$src" "$versioned"
          cp "$versioned" "$latest"

          echo "Built: $versioned"
          echo "Built: $latest"

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: ${{ matrix.id }}
          path: out/

  attach-to-release:
    name: Attach PDFs to Release
    runs-on: ubuntu-latest
    needs: [build-pdfs]

    steps:
      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: dist

      - name: Collect PDFs
        shell: bash
        run: |
          set -euo pipefail
          shopt -s nullglob

          mkdir -p release
          find dist -type f -name "*.pdf" -print -exec cp {} release/ \;

          ls -la release

      - name: Attach PDFs to GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          files: release/*.pdf
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
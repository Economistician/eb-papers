name: Build EB PDFs (Release Assets)

on:
  push:
    tags: ["v*"]
  workflow_dispatch:

permissions:
  contents: write

jobs:
  build-pdfs:
    runs-on: ubuntu-latest

    strategy:
      fail-fast: false
      matrix:
        include:
          # --- Technical Notes ---
          - id: TN-CWSL
            working_directory: cwsl/technical-notes
            base_name: ElectricBarometer_TN_CWSL

          - id: TN-CWSLR
            working_directory: cwslr/technical-notes
            base_name: ElectricBarometer_TN_CWSLR

          - id: TN-FRS
            working_directory: frs/technical-notes
            base_name: ElectricBarometer_TN_FRS

          - id: TN-HRAT
            working_directory: hrat/technical-notes
            base_name: ElectricBarometer_TN_HRAT

          - id: TN-NSL
            working_directory: nsl/technical-notes
            base_name: ElectricBarometer_TN_NSL

          - id: TN-RAL
            working_directory: ral/technical-notes
            base_name: ElectricBarometer_TN_RAL

          - id: TN-UD
            working_directory: ud/technical-notes
            base_name: ElectricBarometer_TN_UD

          # --- Paper ---
          - id: PAPER-FRF
            working_directory: frf/paper
            base_name: ElectricBarometer_PAPER_FRF

    steps:
      - name: Check out repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Compile LaTeX
        uses: xu-cheng/latex-action@v3
        env:
          # Technical notes do \input{010_overview} but files live in ./sections/
          TEXINPUTS: ".:./sections/:"
        with:
          root_file: main.tex
          working_directory: ${{ matrix.working_directory }}

      - name: Create versioned PDF file
        shell: bash
        run: |
          set -euo pipefail
          TAG="${GITHUB_REF_NAME}"  # e.g., v0.2.1

          mkdir -p out
          src="${{ matrix.working_directory }}/main.pdf"
          out="out/${{ matrix.base_name }}_${TAG}.pdf"

          mv "$src" "$out"
          echo "Built: $out"

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: ${{ matrix.id }}
          path: out/*.pdf

  attach-to-release:
    runs-on: ubuntu-latest
    needs: [build-pdfs]

    steps:
      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: dist

      - name: Collect PDFs
        shell: bash
        run: |
          set -euo pipefail
          mkdir -p release
          find dist -type f -name "*.pdf" -print -exec cp {} release/ \;
          ls -la release

      - name: Attach PDFs to GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          files: release/*.pdf
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}